<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כתיבת פוסט חדש - הכותבים</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="site-title">
                <h1 class="main-title">הכותבים</h1>
                <p class="subtitle">ודון קישוט של המילים</p>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-button">דף הבית</a>
                <a href="posts.html" class="nav-button">כל הפוסטים</a>
                <a href="post-editor.html" class="nav-button admin active">כתיבת פוסט חדש</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="admin-panel">
            <h1>יצירת פוסט חדש</h1>
            <form id="postForm" class="post-form">
                <div class="form-group">
                    <label for="title">כותרת:</label>
                    <input type="text" id="title" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="summary">תקציר:</label>
                    <textarea id="summary" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="content">תוכן:</label>
                    <div class="editor-toolbar">
                        <button type="button" onclick="formatText('bold')" class="toolbar-button"><strong>B</strong></button>
                        <button type="button" onclick="formatText('italic')" class="toolbar-button"><em>I</em></button>
                        <button type="button" onclick="formatText('h2')" class="toolbar-button">כותרת</button>
                        <button type="button" onclick="addLink()" class="toolbar-button">קישור</button>
                        <button type="button" onclick="formatText('ul')" class="toolbar-button">•</button>
                    </div>
                    <textarea id="content" class="form-control editor-content" rows="15"></textarea>
                </div>

                <div class="form-group">
                    <label for="tags">תגיות (הפרד בפסיקים):</label>
                    <input type="text" id="tags" class="form-control">
                </div>

                <div class="form-actions">
                    <button type="submit" class="button">שמור ופרסם</button>
                    <button type="button" class="button secondary" onclick="saveDraft()">שמור טיוטה</button>
                </div>

                <div id="preview" class="preview-panel">
                    <h3>תצוגה מקדימה</h3>
                    <div id="previewContent"></div>
                </div>
            </form>
        </div>
    </main>

    <style>
        .editor-toolbar {
            background: #f5f5f5;
            padding: 0.5rem;
            border-radius: 8px 8px 0 0;
            border: 1px solid #ddd;
            border-bottom: none;
        }

        .toolbar-button {
            background: white;
            border: 1px solid #ddd;
            padding: 5px 10px;
            margin-left: 5px;
            border-radius: 4px;
            cursor: pointer;
            min-width: 35px;
        }

        .toolbar-button:hover {
            background: #f0f0f0;
        }

        .editor-content {
            border-radius: 0 0 8px 8px;
            min-height: 300px;
            font-family: inherit;
        }

        .preview-panel {
            margin-top: 2rem;
            padding: 2rem;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            background: white;
        }

        .form-actions {
            margin: 2rem 0;
        }

        #previewContent {
            margin-top: 1rem;
        }
    </style>

    <script>
        function formatText(style) {
            const textarea = document.getElementById('content');
            const selection = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
            let formatted = '';

            switch(style) {
                case 'bold':
                    formatted = `<strong>${selection}</strong>`;
                    break;
                case 'italic':
                    formatted = `<em>${selection}</em>`;
                    break;
                case 'h2':
                    formatted = `\n<h2>${selection}</h2>\n`;
                    break;
                case 'ul':
                    formatted = `\n<ul>\n  <li>${selection}</li>\n</ul>\n`;
                    break;
            }

            insertAtCursor(textarea, formatted);
            updatePreview();
        }

        function addLink() {
            const url = prompt('הכנס את כתובת הקישור:');
            if (url) {
                const textarea = document.getElementById('content');
                const selection = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
                const text = selection || prompt('הכנס את הטקסט לקישור:') || url;
                const link = `<a href="${url}">${text}</a>`;
                insertAtCursor(textarea, link);
                updatePreview();
            }
        }

        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            textarea.value = before + text + after;
            textarea.focus();
        }

        function updatePreview() {
            const content = document.getElementById('content').value;
            document.getElementById('previewContent').innerHTML = content;
        }

        function saveDraft() {
            const draftData = {
                title: document.getElementById('title').value,
                summary: document.getElementById('summary').value,
                content: document.getElementById('content').value,
                tags: document.getElementById('tags').value,
                lastSaved: new Date().toISOString()
            };

            localStorage.setItem('postDraft', JSON.stringify(draftData));
            alert('הטיוטה נשמרה בהצלחה!');
        }

        document.getElementById('content').addEventListener('input', updatePreview);

        document.getElementById('postForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const postData = {
                id: Date.now().toString(),
                title: document.getElementById('title').value,
                summary: document.getElementById('summary').value,
                content: document.getElementById('content').value,
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()),
                date: "2025-03-05T22:57:41Z",
                author: "huxhkuh"
            };

            try {
                // ניסיון לקרוא את הקובץ הקיים
                const response = await fetch('https://raw.githubusercontent.com/Don-Quixote-of-words/docs/main/posts.json');
                let currentData = { posts: [] };
                
                if (response.ok) {
                    currentData = await response.json();
                }

                // הוספת הפוסט החדש לתחילת המערך
                currentData.posts.unshift(postData);
                currentData.lastUpdate = postData.date;

                // יצירת תוכן חדש לקובץ
                const newContent = JSON.stringify(currentData, null, 2);

                // יצירת URL לפתיחת PR
                const encodedContent = encodeURIComponent(newContent);
                const prTitle = encodeURIComponent(`הוספת פוסט: ${postData.title}`);
                const prBody = encodeURIComponent(`פוסט חדש נוסף: ${postData.title}\n\nתקציר: ${postData.summary}`);

                const url = `https://github.com/Don-Quixote-of-words/docs/new/main?filename=posts.json&value=${encodedContent}&message=${prTitle}&description=${prBody}`;
                
                window.open(url, '_blank');

                // שמירה במטמון המקומי
                localStorage.setItem('postsCache', JSON.stringify(currentData));

                // מחיקת הטיוטה
                localStorage.removeItem('postDraft');

                alert('הפוסט נשלח בהצלחה! נא לאשר את השינויים ב-GitHub');

            } catch (error) {
                console.error('Error:', error);
                alert('אירעה שגיאה בשמירת הפוסט. אנא נסה שוב.');
            }
        });

        // טעינת טיוטה אם קיימת
        window.addEventListener('load', function() {
            const savedDraft = localStorage.getItem('postDraft');
            if (savedDraft) {
                const draft = JSON.parse(savedDraft);
                document.getElementById('title').value = draft.title || '';
                document.getElementById('summary').value = draft.summary || '';
                document.getElementById('content').value = draft.content || '';
                document.getElementById('tags').value = draft.tags || '';
                updatePreview();
            }
        });
    </script>
</body>
</html>
